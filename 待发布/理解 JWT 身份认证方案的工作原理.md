# 理解 JWT 身份认证方案的工作原理

JWT（JSON Web Token）是身份认证方案，我们可以分为以下几个步骤来理解它的工作原理：

### 1. **JWT 结构**

JWT 是由三部分组成的：

- **Header**：通常包含令牌的类型（JWT）和签名算法（如 HMAC SHA256 或 RSA）。
- **Payload**：存放声明（claims），也就是存储用户身份信息的地方，比如用户 ID、权限等。
- **Signature**：这部分是用密钥加密了前两部分的内容，用来保证数据的完整性和防止篡改。

### 2. **JWT 的生成过程**

- 用户在登录时，后端验证用户身份（比如通过用户名和密码）。
- 一旦验证通过，后端生成一个 JWT，并把它发送给前端。JWT 中包含了用户的身份信息和过期时间等字段。

### 3. **前端存储和发送**

- 前端通常将 JWT 存储在浏览器的 `localStorage` 或 `sessionStorage` 中，或者存储在 cookies 中（如果你使用 `HttpOnly` 属性来避免被 JS 攻击）。
- 每次请求时，前端将 JWT 放入请求头中（通常是 `Authorization: Bearer <token>`）。

### 4. **后端验证**

- 后端接收到带有 JWT 的请求后，会用预设的密钥对 JWT 的 Signature 部分进行验证，确保它没有被篡改或伪造。如果有效，后端就可以从 Payload 中读取用户的信息，而不需要查询数据库或者存储 JWT。
- 后端不需要存储 JWT，因为 JWT 本身已经包含了验证信息，它是自包含的（self-contained）。如果签名和 payload 一致且 JWT 没有过期，那么就是合法的。

### 5. **过期与刷新**

- JWT 通常有一个有效期（比如 `exp` 字段表示过期时间）。
- 如果 JWT 过期，前端需要使用 **Refresh Token** 机制来重新获取一个新的 JWT。通常流程是：

  - 前端发送请求时，发现 JWT 过期，前端就用 Refresh Token 向后端请求一个新的 JWT。
  - 后端根据 Refresh Token 判断其有效性，如果有效，生成新的 JWT 并返回。

### 6. **JWT 的优缺点**

#### 优点：

- **无状态**：后端不需要保存 session，减少了存储压力。
- **跨平台**：JWT 是基于标准的，能够跨多个平台使用，前后端分离的架构中非常适合。
- **自包含**：JWT 包含了所有必要的信息，不需要额外的数据库查询。

#### 缺点：

- **无法撤销**：一旦 JWT 发出，如果用户登出或更改权限，JWT 无法被立即撤销，除非设置短时间过期并定期刷新。
- **存储安全问题**：如果 JWT 存在前端，可能会被窃取，特别是存储在不安全的地方（如 localStorage）。
